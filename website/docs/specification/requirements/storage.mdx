---
sidebar_position: 4
---

import { BalancedMetricsTip, Metric } from '@site/src/MetricsTip';
import { Diagram } from '@site/src/Diagram';

# Хранилище

<BalancedMetricsTip improves={[Metric.RegressionProtection, Metric.Maintainability, Metric.Speed]} />

Хранилище включает функции, которые выполняют *сайд-эффекты*. Эти эффекты делают другие функции в приложении
*неидемпотентными*. Относится к секции [*результата*](/specification/requirements/borders#определение-границ).

Рассмотрим простой пример:

```ts
/**
 * Функция getUsers возвращает список пользователей из БД.
 * При первом запуске список пуст, так как пользователи ещё не добавлены.
 */
await getUsers(); // []

/**
 * Функция addUser добавляет нового пользователя в БД.
 */
await addUser({ name: 'Vasiliy' });

/**
 * При повторном вызове getUsers результат изменится.
 */
await getUsers(); // [{ id: 1, name: 'Vasiliy' }]
```

Функция `getUsers` стала не [идемпотентной](/specification/requirements/env#идемпотентность) из-за функции `addUser`.

## Сайд-эффект

Эффект — это дополнительное значение, возвращаемое функцией помимо основного результата:

```ts
/**
 * Функция возвращает удвоенное число и строку для логирования.
 */
function doubleAndLog(n: number) {
    return [n * 2, `Doubled a number ${n}`];
}
```

Сайд-эффект — это результат, который:

* Не возвращается функцией.
* Влияет на поведение других функций.

```ts
function addUser(): Promise<void> {
    /**
     * addUser выполняет сайд-эффект:
     * * Изменяет БД.
     * * Не возвращает значение (void).
     */
    return fetch(/* ... */);
}
```

:::warning Внимание
Если не изменить функцию `addUser`, это увеличит время тестов и снизит их воспроизводимость. Таким образом, любые
сайд-эффекты на внешние системы должны быть исключены.
:::

:::tip
Функции, основная задача которых — выполнение сайд-эффектов, называют *командами*. Команды нельзя мемоизировать.
:::

## Другие примеры

Мутирующие серверные методы — не единственный пример. К этой категории также относятся:

* Физические возможности устройств (например, звуки, вибрации, передача по Bluetooth).
* Передача данных в сторонние сервисы (например, оплата, SSO).

:::note
Перечисленные методы подчиняются общему правилу: выполняют сайд-эффекты во внешние хранилища.
:::

## Способ верификации

Функции, выполняющие сайд-эффекты, проверяются методом сравнения журнала их вызовов.

```ts
/**
 * В начале журнал вызовов пуст — []
 */


/**
 * После первого вызова в журнале появится запись с информацией о вызове и переданных аргументах.
 * [["addUser", [{ name: 'Vasiliy' }]]]
 */
await addUser({ name: 'Vasiliy' });

/**
 * Журнал будет пополняться при вызове подобных функций далее.
 */
```

Во время тестов программа вызывает методы и заполняет журнал. В конце работы журнал сравнивается с [эталоном](/specification/requirements/borders#схема-работы), чтобы
проверить корректность работы приложения.

Схема процесса:
<Diagram src={require('./assets/journal.drawio.png')} />

:::tip
Можно представить, что внешнее хранилище (например, БД) — это монитор, на который приложение *отражает* сайд-эффекты.
Это отражение зависит от порядка вызовов методов и их аргументов.
:::

## Связь с библиотекой

`storyshots` позволяет тестировать функции, подобные `addUser`, двумя способами:

* С использованием [журнала вызовов](/specification/requirements/storage#способ-верификации) (рекомендуется для большинства случаев).
* С помощью [эмуляции поведения](/patterns/externals#эмуляция-externals) (усложняет тесты, но повышает защиту от регресса).
