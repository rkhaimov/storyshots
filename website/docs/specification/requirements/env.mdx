---
sidebar_position: 3
---

import { BalancedMetricsTip, Metric } from '@site/src/MetricsTip';

# Внешняя среда

<BalancedMetricsTip improves={[Metric.Maintainability, Metric.Speed]} />

Внешняя среда включает в себя всё, что связано с данными, полученными извне.
Относится к секции [*аргументов*](/specification/requirements/borders#определение-границ).

Рассмотрим простой пример — класс `Date`, используемый для получения текущей даты.

```ts
+new Date(); // 1741963243818

await wait(5_000);

// Функция получения текущей даты возвращает разный результат в зависимости от времени запуска
+new Date(); // 1741963320257
```

Обратите внимание, что функция получения текущей даты вернула разный результат, хотя аргументы, переданные в неё, не
изменились. Это ключевое свойство неидемпотентных (недетерминированных) функций.

## Идемпотентность

Идемпотентными (или детерминированными) называются функции, результат которых полностью определяется их входными
аргументами:

```ts
// Функция double является идемпотентной
const double = (n: number) => n * 2;

// Если вызвать её с тем же аргументом повторно
double(5); // 10

// Результат будет одинаковым
double(5); // 10
```

:::tip
Идемпотентные функции можно рассматривать как процедуры, которые можно *мемоизировать*.
:::

## Текущая дата

[//]: # (TODO ссылки)

Функция получения текущей даты возвращает разное значение в зависимости от времени запуска тестов, что создаёт проблему,
так как [метод верификации через снимки](/specification/requirements/monitor) несовместим с таким поведением.

:::warning Внимание
Если оставить функцию получения текущей даты или любую другую подобную функцию, снимки будут отличаться от запуска к
запуску, что сводит пользу тестирования на нет.
:::

## Ассинхронные данные

Прежде чем переходить к рассмотрению конкретных решений, важно изучить ещё один источник влияния внешней среды на
тестируемое приложение.

```ts

/**
 * Представим, что существует функция, которая позволяет подписаться на событие выхода компьютера из сна.
 * Используя внутри Web API, она вызывает обработчик handle при этом событии и передаёт в него общее время сна.
 */
function onComputerWakeUp(handle: (sleptForMS: number) => void) {
    /* ... */
}
```

Функционал, зависящий от `onComputerWakeUp`, будет сложно протестировать, если это вообще возможно. Если пример кажется
надуманным, рассмотрим следующий:

```ts
// Показать уведомление
const notification = showMessage('Сообщение прочитано');

// Закрыть через 5 секунд
setTimeout(() => notification.close(), 5_000);
```

Здесь проблематичной выглядит функция `setTimeout` которая концептуально не сильно отличается от `onComputerWakeUp`
представленной выше.

Обе функции являются *ассинхронными* по своей природе и могут передать данные приложению далеко не сразу.

## Асинхронные списки

Асинхронно можно вернуть не только одно значение, но и целый набор:

```ts
function onEachSecond(onSecond: (now: Date) => void) {
    setInterval(() => onSecond(new Date()), 1_000);
}
```

Функция `onEachSecond` возвращает не один объект `Date`, а целую последовательность.

:::note
Этот пример особенно интересен тем, что позволяет явно связать компонент внешней среды с *анимациями* на странице.
:::

```ts
/**
 * Анимации, будь то JS или CSS, основываются на счётчике, который определяет частоту и последовательность.
 * Этот счётчик и генерирует асинхронный список в данной модели.
 */
const startedAt = new Date();

onEachSecond((now) => {
    const duration = sub(now, startedAt);

    setPointPositionBy(point, duration);
});
```

:::warning Внимание
Если оставить `setTimeout`, `setInterval`, анимации и другие подобные элементы без изменений, это не только увеличит
время выполнения тестов, но и повысит их [хрупкость](/specification/main-problems#две-крайности).
:::

## Запросы к серверу

Неизменяющие (например **GET**) запросы к серверу также можно отнести к этой категории. Они сочетают в себе обе
указанные проблемы: являются асинхронными и недетерминированными.

## Связь с библиотекой

`storyshots` предлагает следующие варианты работы с внешней средой приложения:

* Анимации, мигающие курсоры и переходы подменяются библиотекой **автоматически**.
* Для JS анимаций следует использовать [testing](/API/story-elements/story-config#testing) флаг.
* Компоненты Web API, такие, как `setTimeout`, `Date` и другие, можно заменить [инвазивным](/patterns/replace#подмена-через-инверсию) и [неинвазивным](/patterns/replace#подмена-через-сайд-эффекты)
  способом.
* Серверные методы подменяются с помощью [arrange](/API/factories/it#arrange)

:::note
Объёкт `externals` заключает в себе внешнюю среду, представляя её как значение.
:::
