---
sidebar_position: 1
---

import { Diagram } from '@site/src/Diagram';

# Архитектура

Общая архитектура решения через призму взаимодействия модулей выглядит следующим образом:

<Diagram src={require('./assets/scheme.drawio.png')} />

:::note
На диаграмме представлены все основные слои на которых располагаются лишь некоторые из существующих модулей. Полный
перечень привёдён в отдельном разделе.
:::

## AUT

AUT - это тестируемая часть приложения. Чем она больше, тем больше покрытие тестов и тем лучше они защищают от регресса.

### IExternals

Интерфейс взаимодействия с [внешней средой](/specification/requirements/env): методы обращения к серверу и web-api.

:::note
Чаще всего, на проектах данный интерфейс существует в неявном виде, то есть не объявлен в принципе.
:::

## Менеджер историй

Основной слой `storyshots`, состоит из единственного пакета `@storyshots/core`. В его ответственности входит:

- **Базовые примитивы** - описывает основные сущности проекта: истории, трансформации, конфигурации.
- **UI режим** - реализует UI режим управления историями
- **Фоновый режим** - реализует фоновый режим запуска историй
- **Тестирование** - реализует всё что касается тестов: работа со слепками, обновления эталонов, обработки ошибок,
  определение пройденных сценариев.

:::note
Является полностью независимым от используемого на проекте стека за счёт интерфейсов `IPreviewDisplay` и
`IPreviewServer`.
:::

### IPreviewDisplay

Интерфейс описывающий контракт для превью, требующий:

* Предоставление историй через глобальный канал `onPreviewReady`.
* Отображение истории по заданным параметрам в корне DOM.

### IPreviewServer

Описывает реальный или виртуальный сервер превью. В его обязанности входит предоставление необходимой статики для
отображения AUT.

##### handler

Обработчик входящих запросов клиента. Обычно это запросы на статические ресурсы превью:

```ts
{
  // Пример простого обработчика, возвращающего предсобранный index.html
  handler: (req, res, next) => {
    if (req.url.includes('index.html')) {
      res.sendFile(path.join('dist', 'index.html'));
    } else {
      next();
    }
  },
  /* ... */
}
```

:::note
Функция `handler` встраивается в метод `app.use` библиотеки `express` и представляет
собой [middleware](https://expressjs.com/en/guide/writing-middleware.html#writing-middleware-for-use-in-express-apps).
:::

Область применения `handler` выходит за пределы обычного сервера статики превью и может использоваться для реализации
более сложных поведений, необходимых для тестирования:

```ts
// Функция будет подменять все запросы к изображениям специальной заглушкой
function createImageStubber(): PreviewServer {
  return {
    handler: (req, res, next) => {
      if (isImageReq(req)) {
        res.sendFile('stub.png');
      } else {
        next();
      }
    },
    /* ... */
  };
}

// mergeServe комбинирует разные серверы превью в один
const server = mergeServe(createImageStubber(), createPreviewServer());
```

#### cleanup

Функция, вызывающаяся при закрытии сервера. Используется для освобождения занятых ресурсов.

#### onUpdate

Функция, выполняющая подписку на обновления статики превью. Необходима для автоматического перезапуска теста в
режиме [UI](/ui/).

```ts
{
  onUpdate: (handler) =>
    /**
     * handler принимает текущий hash обозначающий содержимое превью, если хеш изменился,
     * то storyshots будет считать что AUT обновился.
     */
    compiler.hooks.done.tap('PreviewUpdate', (stats) => handler(stats.hash)),
  /* ... */
}
```

## Адаптеры AUT

Слой содержащий компоненты, адаптирующие AUT под интерфейс `IPreviewDisplay`.

:::tip
Пакет `@storyshots/react` адаптирует `react` приложения для менеджера `storyshots`.
:::

:::note
Для использования `storyshots` в, например, `vue` приложении, всё что нужно сделать так это реализовать интерфейс
`IPreviewDisplay`.
:::

## Серверы AUT

Слой содержит адаптеры сборщиков и серверов AUT на интерфейс `IPreviewServer`.

- [`@storyshots/webpack`](/modules/webpack) - адаптер для AUT использующих `webpack` в качестве сборщика.
- [`@storyshots/proxy`](/modules/proxy) - fallback адаптер перенаправляющий обращения `storyshots` на сервер AUT.

:::tip
`@storyshots/proxy` рекомендуется использовать в случаях когда сложно интегрировать сборщик в сервер
`storyshots` в качестве `middleware`.
:::

## Адаптеры внешней среды

Адаптируют [внешнюю среду](/specification/requirements/env) AUT на совместимые
со `storyshots` [заглушки](/specification/requirements/env).

- `pure` - это условное обозначение компонента. Описывает [один из способов](/patterns/replace#подмена-через-инверсию)
  самостоятельной подмены
  [внешних зависимостей](/specification/requirements/env).
- [`@storyshots/msw-externals`](/modules/msw) - реализует [не инвазивный метод](/patterns/replace#подмена-через-сайд-эффекты)
  подмены с помощью библиотеки `msw`.
